# Phase 8 完了レポート: 学習パイプライン修正 + ストレージ自動クリーンアップ

## 実施日
2026-02-28

## 環境
- macOS Darwin 25.2.0
- Python 3.9
- Gemini 2.0 Flash（学習パイプライン用AIプロバイダー）

## 概要

学習パイプラインが完全に停止していた問題を修正し、ストレージの自動クリーンアップ機構を強化した。

**発見された問題**:
- LaunchAgent から起動時に `.env` が読み込めず `OPENAI_API_KEY` エラーで全セッション失敗
- デフォルトプロバイダーが `openai`（APIキーがコメントアウト済み）
- 学習失敗時にクリーンアップが実行されず、10万ファイル（20GB）が蓄積
- 手動起動の古いプロセス（PID 7945、2日間稼働）と LaunchAgent プロセスが競合

## 変更内容

### pipeline/config.py
- `.env` ファイルの探索パスを修正: `__file__` 基準でプロジェクトルートの `.env` を確実に読み込む
- デフォルト AI プロバイダーを `openai` → `gemini` に変更（`GEMINI_API_KEY` が有効）
- デフォルトモデルを `gpt-5` → `gemini-2.0-flash` に変更

### pipeline/learning_pipeline.py
- 定期クリーンアップ機能を追加: 10分ごとに1時間以上前のファイルを自動削除
- 学習成功・失敗に関わらずクリーンアップが実行されるよう変更
- `_CLEANUP_INTERVAL`（600秒）、`_RETENTION_SEC`（3600秒）を定数化

### ストレージ即時対応
- 2日以上前のファイル約8万件を手動削除（20GB → 4.7GB）
- 古い手動プロセス（PID 7945）を停止、LaunchAgent プロセスのみに統一

## 統計
- 変更ファイル: 3ファイル（+29行 / -6行）
- 削除ファイル: 約80,000件（PNG + JSON、約15GB）

## テスト結果
テストディレクトリなし。LaunchAgent 再起動後、エラーログなしで正常動作を確認。

## 検証結果
- LaunchAgent プロセス（PID 78996）が正常稼働中
- 最新キャプチャファイル（18:23）が生成されていることを確認
- エラーログ: 0行（修正前は `OPENAI_API_KEY` エラーが数百行）

## 次フェーズへの申し送り
- 学習パイプラインの実際のスキル抽出結果を確認する（セッション蓄積後）
- PC 再起動後に LaunchAgent + 学習が正常動作するか実地検証
- ストレージ使用量の経時モニタリング
