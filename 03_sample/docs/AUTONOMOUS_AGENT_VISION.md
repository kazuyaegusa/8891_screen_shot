# 完全自律型AIエージェント - 設計書

> 作成日: 2026-02-06
> 更新日: 2026-02-07
> ステータス: 設計フェーズ

---

## 1. エグゼクティブサマリー

### 解決する課題

現在のAIエージェントは「思考」や「生成」は得意だが、**アプリケーションの操作**ができないため、複数のツールを横断するタスクで人間の介入が必要になる。

**例：週次レポート作成**
```
データ取得(Salesforce) → 分析 → レポート作成(Docs) → 共有(Slack)
        ↑                                    ↑
    アプリ操作が必要                      アプリ操作が必要
    = AIにはできない                      = AIにはできない
```

### 解決策

**Screen Action Recorder**により、人間のアプリ操作を記録・スキル化し、AIが必要に応じて呼び出せるようにする。これにより、AIエージェントが**完全自律**でタスクを遂行できる。

### 目標

- AIがアプリケーションを「操作」できるようにする
- 人間の介入なしで一連の業務を完結
- 社員が働くほど、スキル（操作ノウハウ）が蓄積・改善される仕組み

---

## 2. 現状と課題

### 2.1 現在のAI自動化の限界

| できること | できないこと |
|-----------|-------------|
| テキスト生成 | GUIアプリの操作 |
| データ分析（API経由） | ブラウザでのクリック |
| API呼び出し | ファイルのドラッグ&ドロップ |
| コード生成 | ショートカットキー操作 |

### 2.2 業務フローの断絶

```
[スキルA] ───?───> [スキルB] ───?───> [スキルC]
  分析              レポート作成         共有

    └── この「?」の部分でアプリ操作が必要
        → 人間が介入 → 自動化が止まる
```

### 2.3 既存ツールの問題点

| ツール | 問題点 |
|--------|--------|
| 従来のマクロ | 座標ベース、レイアウト変更で壊れる |
| RPA製品 | 高コスト、設定が複雑 |
| Anthropic Computer Use | スクリーンショットベース、要素IDなし |

---

## 3. 提案するシステム

### 3.1 システム概要

```
┌─────────────────────────────────────────────────────────────────┐
│                      【AIエージェント】                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    オーケストレーター                    │   │
│  │         （タスクを分解し、スキルを組み合わせる）         │   │
│  └─────────────────────────────────────────────────────────┘   │
│           │                    │                    │          │
│           ▼                    ▼                    ▼          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │ 思考スキル   │    │ 操作スキル   │    │ 通信スキル   │      │
│  │              │    │              │    │              │      │
│  │ ・分析       │    │ ・Excel操作  │    │ ・API呼出    │      │
│  │ ・要約       │    │ ・LINE送信   │    │ ・メール送信 │      │
│  │ ・計画       │    │ ・ブラウザ   │    │ ・Slack投稿  │      │
│  └──────────────┘    └──────────────┘    └──────────────┘      │
│                              │                                  │
│                              ▼                                  │
│                 【Screen Action Recorder】                      │
│                   人間の操作を学習して実行                      │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      【スキルサーバー】                         │
│                                                                 │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐      │
│  │ スキルDB     │    │ コンテキストDB│    │ 実行ログDB   │      │
│  │              │    │              │    │              │      │
│  │ ・操作手順   │    │ ・顧客データ │    │ ・成功/失敗  │      │
│  │ ・スクショ   │    │ ・過去の結果 │    │ ・改善履歴   │      │
│  │ ・パラメータ │    │ ・学習データ │    │ ・使用頻度   │      │
│  └──────────────┘    └──────────────┘    └──────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Screen Action Recorderの役割

| 機能 | 説明 |
|------|------|
| **記録** | 人間のクリック、入力、スクロール等を監視・保存 |
| **要素識別** | Accessibility APIで要素のID/名前/役割を取得 |
| **スクリーンショット** | 各操作時点の画面を保存（AI判断の材料） |
| **再生** | 要素を再検索し、同じ操作を自動実行 |
| **スキル化** | 記録をパラメータ化して汎用的に再利用可能に |

### 3.3 スキルの種類

| カテゴリ | 例 | 実現方法 |
|---------|----|---------|
| 思考スキル | 分析、要約、計画 | LLM |
| 操作スキル | アプリ操作、クリック、入力 | Screen Action Recorder |
| 通信スキル | API呼び出し、メール送信 | 既存API |
| データスキル | ファイル読み書き、変換 | Python処理 |

---

## 4. 技術仕様

### 4.1 記録データフォーマット

```json
{
  "skill_id": "send_line_message",
  "skill_name": "LINEメッセージ送信",
  "version": "1.0.0",
  "created_at": "2026-02-06T00:00:00",
  "parameters": [
    {"name": "recipient", "type": "string", "description": "送信先"},
    {"name": "message", "type": "string", "description": "メッセージ内容"}
  ],
  "actions": [
    {
      "action_type": "click",
      "target": {
        "app": "LINE",
        "identifier": "contact_list",
        "fallback_coordinates": {"x": 200, "y": 150}
      },
      "screenshot": "step_001.png"
    },
    {
      "action_type": "key_input",
      "value": "{recipient}",
      "target": {
        "role": "AXSearchField"
      }
    },
    {
      "action_type": "click",
      "target": {
        "role": "AXStaticText",
        "value": "{recipient}"
      }
    },
    {
      "action_type": "key_input",
      "value": "{message}",
      "target": {
        "role": "AXTextArea"
      }
    },
    {
      "action_type": "click",
      "target": {
        "identifier": "send_button",
        "description": "送信"
      }
    }
  ]
}
```

### 4.2 要素検索の優先順位

1. `identifier` 一致（開発者が設定した一意ID）
2. `value` 一致（表示テキスト）
3. `description` 一致（要素の説明）
4. `title` + `role` 一致
5. `role` のみ一致 + 座標近接
6. スクリーンショットからAI推測（フォールバック）

### 4.3 対応予定の操作

| 操作 | 技術 | 状態 |
|------|------|------|
| 左クリック | CGEventCreateMouseEvent | ✅ 実装済 |
| 右クリック | CGEventCreateMouseEvent | ✅ 実装済 |
| キーボード入力 | CGEventCreateKeyboardEvent | ✅ 統合済み（テスト待ち） |
| スクロール | CGEventCreateScrollWheelEvent | 🔲 未実装 |
| ドラッグ&ドロップ | CGEvent (MouseDragged) | 🔲 未実装 |
| ショートカットキー | CGEvent + Modifier flags | 🔲 未実装 |

---

## 5. ユースケース

### 5.1 週次レポート作成

**指示:** 「今週の売上データをまとめて、分析レポートを作成し、チームにSlackで共有して」

**実行フロー:**
```
[1] Salesforce操作スキル
    → ブラウザでSalesforce開く
    → レポート画面へ移動
    → CSV出力ボタンクリック
    → ダウンロード完了待ち
        ↓
[2] データ分析スキル（思考スキル）
    → CSVを読み込み
    → 売上トレンド計算
    → 異常値検出
    → 要約テキスト生成
        ↓
[3] Google Docs操作スキル
    → 新規ドキュメント作成
    → テンプレート適用
    → 分析結果を貼り付け
    → グラフ挿入
        ↓
[4] Slack投稿スキル
    → #sales チャンネルに投稿
    → ドキュメントリンク添付
    → メンション追加
```

### 5.2 顧客対応

**指示:** 「山田様から問い合わせのメールが来たので、過去の対応履歴を確認して返信案を作成して」

**実行フロー:**
```
[1] メール取得 → Gmail API
[2] CRM検索操作スキル → Salesforceで顧客情報検索
[3] 履歴分析 → 思考スキルで過去対応を分析
[4] 返信作成 → 思考スキルで返信案生成
[5] メール下書き作成操作スキル → Gmailで下書き作成
```

### 5.3 データ入力

**指示:** 「このCSVの内容を社内システムに登録して」

**実行フロー:**
```
[1] CSV読み込み → データスキル
[2] 社内システム操作スキル → ログイン、フォーム入力、送信
[3] 結果確認 → 登録完了を確認
```

---

## 6. スキル成長サイクル

### 6.1 サイクル図

```
    社員の日常業務
         │
         ▼
    ┌─────────┐
    │  記録   │  ← 新しい操作を発見
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │ スキル化 │  ← 汎用的なパラメータ抽出
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │  保存   │  ← スキルサーバーに登録
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │  利用   │  ← AIエージェントが呼び出し
    └────┬────┘
         │
         ▼
    ┌─────────┐
    │  改善   │  ← 失敗時に再記録、バリエーション追加
    └────┬────┘
         │
         └──────────────→ 繰り返し
```

### 6.2 成長のメカニズム

| イベント | アクション |
|---------|-----------|
| 新しい操作を発見 | 社員が記録 → 新スキル追加 |
| スキル実行失敗 | 失敗ログ記録 → 人間に再記録依頼 |
| 同じスキルの別パターン | バリエーションとして追加 |
| 古いスキルが動かない | アプリ更新検知 → 再記録依頼 |

### 6.3 蓄積されるデータ

| データ | 用途 |
|--------|------|
| スキル定義 | 操作手順の再利用 |
| スクリーンショット | AI判断、デバッグ |
| 実行ログ | 成功率分析、改善 |
| コンテキストデータ | 顧客情報、過去結果 |

---

## 7. 実装ロードマップ

### Phase 1: 検証（現在）

**期間:** 2週間
**目標:** 様々なアプリで記録・再生が動くか検証

- [ ] ブラウザ操作（Safari/Chrome）
- [ ] ビジネスチャット（Slack）
- [ ] スプレッドシート（Excel/Numbers）
- [ ] ファイル操作（Finder）
- [x] キーボード入力の実装（統合済み）

### Phase 2: スキル化

**期間:** 2週間
**目標:** 記録をパラメータ化して再利用可能に

- [ ] パラメータ抽出機能
- [ ] スキル定義フォーマット
- [ ] スキル保存・読み込み

### Phase 3: オーケストレーション

**期間:** 4週間
**目標:** AIが複数スキルを組み合わせてタスク実行

- [ ] タスク分解エンジン
- [ ] スキル選択ロジック
- [ ] 実行制御（順次、条件分岐）

### Phase 4: 自律改善

**期間:** 4週間
**目標:** スキルが自動で改善される仕組み

- [ ] 失敗検知
- [ ] 再記録リクエスト
- [ ] バージョン管理

### Phase 5: サーバー化

**期間:** 4週間
**目標:** 組織全体でスキルを共有

- [ ] スキルサーバー構築
- [ ] 権限管理
- [ ] 監査ログ

---

## 8. リスクと対策

| リスク | 対策 |
|--------|------|
| アプリUIの頻繁な変更 | 複数の要素識別方法、AI画像認識フォールバック |
| セキュリティ（パスワード等の記録） | センシティブ入力の検知・除外機能 |
| 操作の失敗 | リトライ機構、人間へのエスカレーション |
| パフォーマンス | 操作間の適切な待機時間調整 |

---

## 9. 成功指標

| 指標 | 目標 |
|------|------|
| スキル再生成功率 | 95%以上 |
| 人間介入なしで完了するタスク率 | 80%以上 |
| 蓄積スキル数 | 月50スキル増加 |
| 1タスクあたりの時間削減 | 70%以上 |

---

## 10. 次のアクション

1. **検証フェーズを完了する**
   - 様々なアプリでのテスト実施
   - 問題点の洗い出し

2. **キーボード入力の統合テストを実施する**
   - テキスト入力
   - ショートカットキー

3. **検証結果をもとに設計を修正する**
