# Screen Action Recorder - テスト結果レポート

> 作成日: 2026-02-06
> 対象バージョン: MVP (Phase 1 + Phase 2)

---

## 実施テスト一覧

| # | セッションID | 日時 | アクション数 | テスト対象アプリ | 総合結果 |
|---|---|---|---|---|---|
| 1 | `session_20260205_222336` | 2/5 22:23 | 6 | システム設定 | 成功 |
| 2 | `session_20260206_004402` | 2/6 00:44 | 3 | LINE | 成功 |
| 3 | `session_20260206_120135` | 2/6 12:01 | 4 | ターミナル/Finder/システム設定 | 全失敗 |
| 4 | `session_20260206_121128` | 2/6 12:11 | 35 | ターミナル/Cursor/Finder/テキストエディット | 成功（混在） |

---

## セッション1: システム設定 (A5)

**ファイル:** `mvp_output/session_20260205_222336.json`
**日時:** 2026-02-05 22:23
**アプリ:** システム設定 (`com.apple.systempreferences`)
**操作内容:** 設定画面の戻るボタン、設定項目ナビゲーション

### 結果

- 記録: 成功 (6/6 アクション)
- 要素取得: 成功 (6/6)
- スクリーンショット: 成功

### 取得できた要素情報

| # | role | identifier | title | description | frame |
|---|------|------------|-------|-------------|-------|
| 1 | AXButton | go back | - | 戻る | あり |
| 2 | AXButton | go back | - | 戻る | あり |
| 3 | AXStaticText | - | - | - | あり |
| 4 | AXStaticText | - | - | - | あり |
| 5 | AXGroup | - | - | - | あり |
| 6 | AXStaticText | - | - | - | あり |

### 評価

- 「戻る」ボタンは `identifier: "go back"` で一意に再特定可能（高信頼度）
- StaticTextやGroupはidentifierなし → 座標フォールバック依存
- テスト計画の **A5: システム設定** に対応 → **完了**

---

## セッション2: LINE (B1)

**ファイル:** `mvp_output/session_20260206_004402.json`
**日時:** 2026-02-06 00:44
**アプリ:** LINE (`jp.naver.line.mac`)
**操作内容:** コンタクトリスト選択、メッセージ領域クリック、送信ボタン

### 結果

- 記録: 成功 (3/3 アクション)
- 要素取得: 成功 (3/3)
- スクリーンショット: 成功

### 取得できた要素情報

| # | role | identifier | value | frame |
|---|------|------------|-------|-------|
| 1 | AXStaticText | - | (テキスト) | あり |
| 2 | AXTextArea | - | (テキスト) | あり |
| 3 | AXImage | - | - | あり |

### 評価

- frame情報は全て取得成功
- identifierは取得不可 → LINE独自のUI実装のため
- value（テキスト内容）で補助的に特定可能
- テスト計画の **B1: LINEクリックのみ** に対応 → **完了**

---

## セッション3: クロスアプリ操作（権限エラー）

**ファイル:** `mvp_output/session_20260206_120135.json`
**日時:** 2026-02-06 12:01
**アプリ:** ターミナル、Finder、システム設定
**操作内容:** 複数アプリ間でのクリック

### 結果

- 記録: 失敗 (0/4 アクション)
- 要素取得: **全失敗** (エラーコード: -25211)
- スクリーンショット: **全失敗** (`screenshot_path: null`)

### エラー詳細

全4アクションで同一エラー:

```json
{
  "error": "No element found at (x, y)",
  "code": -25211
}
```

### 原因分析

- エラーコード `-25211` = **kAXErrorCannotComplete**
- Accessibility権限が一時的に無効だった可能性が最有力
- スクリーンショットも失敗していることから、権限付与直後のリセット待ちの可能性
- **対策:** レコーダー起動時に権限チェックを行い、失敗時は明確に警告する

---

## セッション4: 大規模クロスアプリテスト

**ファイル:** `mvp_output/session_20260206_121128.json`
**日時:** 2026-02-06 12:11
**アプリ:** ターミナル、UserNotificationCenter、Cursor、Finder、テキストエディット
**操作内容:** 35アクションにわたる複数アプリ操作
**テスト計画対応:** A1(Finder), E3(右クリック) の部分テスト含む

### 結果サマリ

- 記録: 成功 (35/35 アクション)
- 要素取得: **成功 (35/35 = 100%)**
- スクリーンショット: 成功 (35/35)

### アプリ別の詳細分析

#### ターミナル (`com.apple.Terminal`) - 4アクション

| 指標 | 結果 |
|------|------|
| 要素取得 | 4/4 成功 |
| role | AXTextArea |
| identifier | なし |
| description | "シェル" |
| frame | **取得失敗 (null)** |
| 再生信頼度 | **低** (descriptionのみ、frame欠損) |

**問題:** `AXPosition`/`AXSize`は`available_attributes`に含まれているにもかかわらず、frameがnull。パース処理のバグが疑われる。

#### UserNotificationCenter - 1アクション

| 指標 | 結果 |
|------|------|
| 要素取得 | 1/1 成功 |
| role | AXButton |
| identifier | "action-button-1" |
| title | "許可" |
| frame | あり (663, 475, 230x30) |
| 再生信頼度 | **高** (identifier + title + frame) |

**評価:** システムダイアログのボタンは完璧に特定可能。

#### Cursor (`com.todesktop.230313mzl4w4u92`) - 8アクション

| 指標 | 結果 |
|------|------|
| 要素取得 | 8/8 成功 |
| identifier取得 | 0/8 (全てnull) |
| title取得 | 0/8 (全てnull) |
| description取得 | 0/8 (全てnull) |
| frame取得 | 6/8 |
| 再生信頼度 | **低** (識別情報なし) |

**発見事項:**
- Electron系アプリはAX識別情報がほぼ空
- `AXDOMIdentifier`, `AXDOMClassList` というWeb由来の属性が存在
- roleは `AXImage`, `AXGroup`, `AXStaticText` が取得可能
- value例: `" zsh"`, `""` → 一部テキストは取得可能
- **改善案:** `AXDOMIdentifier`/`AXDOMClassList`を追加取得して要素特定に利用

#### Finder (`com.apple.finder`) - 12アクション

| 指標 | 結果 |
|------|------|
| 要素取得 | 12/12 成功 |
| identifier取得 | 1/12 (`cmdRename:`) |
| title取得 | 1/12 (`名称変更`) |
| value取得 | 2/12 (`ファイルA.txt`, `autonomous_agent_test`) |
| frame取得 | 12/12 (全て成功) |
| 再生信頼度 | **中** (AXGroupが多く区別困難) |

**発見事項:**
- `AXGroup`が圧倒的に多い（カラム表示のファイルアイコン+ラベル）
- ダブルクリックでファイル名編集モードに入ると `AXTextField` + `value: "ファイルA.txt"` が取得可能
- 右クリックメニューの項目は非常に高品質: `identifier: "cmdRename:"`, `title: "名称変更"`, `description: "名称変更"`
- **右クリック記録の成功確認** (`action_type: "right_click"`)

#### テキストエディット (`com.apple.TextEdit`) - 10アクション

| 指標 | 結果 |
|------|------|
| 要素取得 | 10/10 成功 |
| identifier取得 | 4/10 (`First Text View` x3, `_NS:34` x1) |
| title取得 | 4/10 (`ファイルA.txt` x3, `保存` x1) |
| value取得 | 3/10 (RTFテキスト内容) |
| frame取得 | 10/10 (全て成功) |
| 再生信頼度 | **高** (identifier + title充実) |

**発見事項:**
- テキスト編集領域: `identifier: "First Text View"` → 一意に特定可能
- ウィンドウ: `identifier: "_NS:34"`, `title: "ファイルA.txt"` → ファイル名ベースで特定可能
- 保存ダイアログ: `identifier: "action-button--1099"`, `title: "保存"` → 完璧
- ネイティブmacOSアプリのAX情報は非常に豊富

---

## 全セッション横断の統計

### 要素取得の成功率

| 指標 | 値 | 備考 |
|------|------|------|
| 総アクション数 | 48 | (6+3+4+35) |
| 要素取得成功 | 44/48 = **91.7%** | セッション3除外で100% |
| 要素取得失敗 | 4/48 | 全てセッション3 (権限問題) |

### 識別情報の取得率 (成功44アクション中)

| 属性 | 取得数 | 取得率 | 再生への貢献度 |
|------|--------|--------|---------------|
| identifier | 8/44 | **18.2%** | 最高（一意特定） |
| title | 8/44 | **18.2%** | 高（role組み合わせ） |
| value | 12/44 | **27.3%** | 中（変化しうる） |
| description | 8/44 | **18.2%** | 中 |
| frame | 37/44 | **84.1%** | 低（座標算出用） |

### 再生信頼度の予測

| 信頼度 | 割合 | 条件 |
|--------|------|------|
| **高信頼** | ~36% | identifier or title+roleで特定可能 |
| **中信頼** | ~27% | valueで補助的に特定可能 |
| **低信頼** | ~37% | frame+roleのみ → 座標フォールバック依存 |

### アプリ別の対応状況

| アプリ種別 | 代表例 | AX情報の質 | 再生可能性 |
|-----------|--------|-----------|-----------|
| macOSネイティブ | テキストエディット、システム設定 | 優秀 | 高 |
| macOSシステム | Finder、通知センター | 良好 | 中〜高 |
| チャットアプリ | LINE | 普通 | 中 |
| Electron系 | Cursor | 貧弱 | 低 |
| ターミナル | Terminal.app | やや不足 | 低〜中 |

---

## 判明した問題と改善項目

### 問題1: ターミナルのframe取得失敗

- **症状:** `available_attributes`に`AXPosition`/`AXSize`があるのに`frame: null`
- **原因推定:** `AXValueRef`の文字列表現が正規表現パターン `x:(数値) y:(数値)` に合致しない可能性
- **優先度:** 中
- **対応案:** パースパターンの拡張、またはCoreFoundationのCGPoint/CGSize直接取得

### 問題2: Electron系アプリの識別情報不足

- **症状:** Cursorでidentifier/title/descriptionが全てnull
- **原因:** Electronアプリは標準的なAX属性を公開しない
- **優先度:** 中
- **対応案:** `AXDOMIdentifier`, `AXDOMClassList`を追加取得、Phase 3のAI Vision補完

### 問題3: FinderのAXGroupの区別困難

- **症状:** ファイル一覧の各項目が同一の`AXGroup`として記録される
- **優先度:** 低
- **対応案:** 子要素のテキスト（ファイル名）を取得して補助情報に追加

### 問題4: キーボード入力が未実装

- **症状:** テキスト入力を伴う操作シナリオがテスト不能
- **優先度:** **最高**
- **対応案:** 次フェーズで実装 → `KEYBOARD_INPUT_VERIFICATION.md` 参照

---

## テスト計画の進捗

| テストID | 内容 | ステータス | セッション |
|----------|------|-----------|-----------|
| A1 | Finder ファイル操作 | **部分完了** (クリック記録確認済み、右クリックメニュー確認済み) | #4 |
| A5 | システム設定 | **完了** | #1 |
| B1 | LINE クリックのみ | **完了** | #2 |
| E3 | 右クリックメニュー | **完了** (Finder右クリック→名称変更) | #4 |
| B2 | LINE 入力込み | 未着手 (キーボード実装待ち) | - |
| C1 | Safari URL入力 | 未着手 (キーボード実装待ち) | - |
| D1 | Numbers セル入力 | 未着手 (キーボード実装待ち) | - |
| E4 | ショートカットキー | 未着手 (キーボード実装待ち) | - |

---

## 結論

MVPのクリック記録機能は**安定して動作**している。権限が正しく付与されていれば要素取得成功率は100%。ネイティブmacOSアプリでは豊富な識別情報が得られ、再生の信頼度も高い。

**次の最重要課題: キーボード入力の記録・再生機能の実装**
